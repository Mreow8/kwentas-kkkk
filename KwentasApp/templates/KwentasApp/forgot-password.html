{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kwentas Klaras - Forgot Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a81368914c.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-white dark:bg-gray-900">
    <section class="bg-white dark:bg-gray-900">
        <div class="container flex flex-col items-center justify-center min-h-screen px-6 mx-auto">
            <div class="flex justify-center mx-auto">
                <img class="w-auto h-16 drop-shadow-xl" src="{% static 'KwentasApp/img/logo.png' %}" alt="Kwentas Klaras Logo">
            </div>

            <h1 class="mt-2 text-xl font-semibold tracking-wide text-center text-gray-800 capitalize md:text-2xl dark:text-white">
                Forgot Password?
            </h1>

            <p class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400">
                Enter your email address below and we'll send you a verification code to reset it.
            </p>

            <div class="w-full max-w-md mx-auto mt-4">
                <form id="forgot-password-form" method="POST" autocomplete="off" class="space-y-3">
                    {% csrf_token %}
                    <div>
                        <label class="block mb-1 text-sm text-gray-600 dark:text-gray-200">Email Address</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" 
                            class="block w-full px-4 py-2 text-gray-700 placeholder-gray-400 bg-white border border-gray-200 rounded-lg dark:placeholder-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:border-gray-700 focus:border-blue-400 dark:focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40" 
                            required />
                    </div>

                    <button type="button" id="sendCodeButton" 
                        class="w-full px-4 py-2 text-sm font-medium tracking-wide text-white capitalize transition-colors duration-300 transform bg-blue-500 rounded-lg hover:bg-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-50">
                        Send Verification Code
                    </button>

                    <div>
                        <label class="block mb-1 text-sm text-gray-600 dark:text-gray-200">Verification Code</label>
                        <input type="text" id="verification-code" name="code" placeholder="Enter verification code" 
                            class="block w-full px-4 py-2 text-gray-700 placeholder-gray-400 bg-white border border-gray-200 rounded-lg dark:placeholder-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:border-gray-700 focus:border-blue-400 dark:focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40" />
                    </div>

                    <div>
                        <label class="block mb-1 text-sm text-gray-600 dark:text-gray-200">New Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter new password" 
                            class="block w-full px-4 py-2 text-gray-700 placeholder-gray-400 bg-white border border-gray-200 rounded-lg dark:placeholder-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:border-gray-700 focus:border-blue-400 dark:focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40" 
                            disabled />
                    </div>

                    <div>
                        <label class="block mb-1 text-sm text-gray-600 dark:text-gray-200">Confirm Password</label>
                        <input type="password" id="password2" name="password2" placeholder="Confirm new password" 
                            class="block w-full px-4 py-2 text-gray-700 placeholder-gray-400 bg-white border border-gray-200 rounded-lg dark:placeholder-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:border-gray-700 focus:border-blue-400 dark:focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40" 
                            disabled />
                    </div>

                    <button type="submit" 
                        class="w-full px-4 py-2 text-sm font-medium tracking-wide text-white capitalize transition-colors duration-300 transform bg-blue-500 rounded-lg hover:bg-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-50">
                        Change Password
                    </button>

                    <div class="text-center">
                        <a href="{% url 'login' %}" class="text-sm text-blue-500 hover:underline dark:text-blue-400">
                            Back to login
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script>
    document.getElementById('sendCodeButton').addEventListener('click', function() {
        const email = document.querySelector('input[name="email"]').value;

        if (!email) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please enter your email address.'
            });
            return;
        }

        Swal.fire({
            title: 'Sending verification code...',
            html: `
                    <div style="display: flex; justify-content: center; align-items: center;">
                        <img src="{% static 'KwentasApp/img/loaderemail.gif' %}" style="width: 200px; height: 200px;" />
                    </div>
                    <p>Please wait for a moment.</p>
                `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        fetch('/send-verification-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Verification code sent!',
                    text: 'Check your email for the verification code.'
                });
                // Enable the password fields
                document.getElementById('password').disabled = false;
                document.getElementById('password2').disabled = false;
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Failed to send verification code.'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Error sending verification code.'
            });
        });
    });

    document.getElementById('forgot-password-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const email = document.querySelector('input[name="email"]').value;
        const code = document.querySelector('input[name="code"]').value;
        const password = document.querySelector('input[name="password"]').value;
        const password2 = document.querySelector('input[name="password2"]').value;

        if (!code) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please enter the verification code.'
            });
            return;
        }

        if (!password || !password2) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Please enter the new password.'
            });
            return;
        }

        if (password !== password2) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Passwords do not match.'
            });
            return;
        }

        fetch('/verify-and-change-password/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ email: email, code: code, password: password })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Password changed!',
                    text: 'Your password has been successfully changed. You can now log in with your new password.'
                }).then(() => {
                    window.location.href = '{% url "login" %}';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid code',
                    text: 'The verification code is incorrect.'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Error changing password.'
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
</body>
</html>



